=== Внешние интеграции

= Внешние интеграции системы
:icons: font

== Введение

Система "Сервис объявлений с доставкой и оплатой" взаимодействует с несколькими внешними сервисами и провайдерами, которые обеспечивают критически важную функциональность. Все интеграции спроектированы с учетом отказоустойчивости, соблюдения SLA и требований безопасности.

== Таблица внешних интеграций

[cols="2,2,2,3,2", options="header"]
|===
| Категория | Сервис/Провайдер | Тип интеграции | Назначение | Критичность

| Платежные системы
| Stripe
| REST API + Webhooks
| Прием онлайн-платежей (карты, электронные кошельки)
| Высокая

| Платежные системы
| Тинькофф (Tinkoff)
| REST API + Webhooks
| Прием платежей для РФ (карты, СБП)
| Высокая

| Платежные системы
| QIWI
| REST API
| Прием платежей через QIWI-кошельки
| Средняя

| Службы доставки
| СДЭК (CDEK)
| REST API + SOAP
| Расчет стоимости, создание заказов, трекинг посылок
| Высокая

| Службы доставки
| Почта России
| REST API
| Расчет стоимости, создание заказов, трекинг
| Высокая

| Хранилище медиа
| AWS S3 (или совместимое: MinIO, YC Object Storage)
| SDK/API
| Хранение изображений, видео и документов пользователей
| Высокая

| Безопасность
| ClamAV
| TCP Socket / REST
| Антивирусное сканирование загружаемых файлов
| Средняя

| Безопасность
| VirusTotal API (опционально)
| REST API
| Дополнительная проверка файлов
| Низкая

| Мониторинг
| Prometheus / Grafana Cloud
| Metrics Push / Pull
| Сбор метрик и мониторинг производительности
| Высокая

| Логирование
| ELK Stack / Loki
| REST API
| Централизованное хранение и анализ логов
| Высокая
|===

== Детализация критичных интеграций

=== Платежные системы (Stripe/Tinkoff)

[cols="1,3", options="header"]
|===
| Аспект | Описание
| Протокол | REST API (HTTPS с TLS 1.2+)
| Аутентификация | API-ключи, подпись запросов
| SLA провайдера | ≥ 99.9%
| Ретраи | Экспоненциальный backoff (3 попытки)
| Circuit breaker | Да, при 5 ошибках подряд
| Мониторинг | Health checks, метрики success rate
| Вебхуки | Подтверждение подписи, идемпотентность
| Комплаенс | PCI DSS Level 1 (на стороне провайдера)
|===

=== Службы доставки (СДЭК/Почта России)

[cols="1,3", options="header"]
|===
| Аспект | Описание
| Протокол | REST API (JSON), SOAP для legacy
| Кэширование | Тарифы и точки выдачи - 24 часа
| Асинхронность | Создание заказов - асинхронно с колбэками
| Трекинг | Периодический опрос (cron, каждые 6 часов)
| Фоллбэк | При недоступности одного провайдера - переключение на другой
| Валидация | Проверка адресов перед созданием заказа
|===

=== Хранилище медиа (S3-совместимое)

[cols="1,3", options="header"]
|===
| Аспект | Описание
| Модель | Presigned URLs для прямой загрузки
| Бакеты | temp-uploads (временные), media-prod (постоянные)
| Жизненный цикл | Автоудаление из temp через 24 часа
| Репликация | Cross-region для prod бакета
| CDN | CloudFront/Cloudflare для раздачи статики
| Резервное копирование | Versioning + периодические снапшоты
|===

== Требования к интеграциям

[cols="1,4", options="header"]
|===
| Требование | Описание
| Отказоустойчивость | Все интеграции должны иметь circuit breaker и fallback-стратегии
| Мониторинг | Каждая интеграция должна иметь метрики: latency, error rate, timeout count
| Логирование | Детальное логирование запросов/ответов для debugging (без sensitive data)
| Безопасность | API-ключи в Secrets Manager, ротация ключей каждые 90 дней
| Rate limiting | Соблюдение лимитов провайдеров, очередь запросов при превышении
| Идемпотентность | Критичные операции (платежи) должны быть идемпотентными
| Документация | Актуальная Swagger/OpenAPI спецификация для каждой интеграции
| Тестирование | Mock-серверы для интеграционного тестирования, sandbox окружения
|===
