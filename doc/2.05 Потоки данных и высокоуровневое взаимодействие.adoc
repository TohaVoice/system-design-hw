= Потоки данных и высокоуровневое взаимодействие
:icons: font
:imagesdir: doc/images

== Введение

Документ описывает ключевые сценарии взаимодействия между сервисами и внешними системами, а также потоки данных при основных операциях в системе. Акцент делается на событийно-ориентированной архитектуре и шаблонах Saga для обеспечения согласованности данных.

== Ключевые сценарии взаимодействия

=== 1. Создание и публикация объявления

.Схема процесса создания и публикации объявления
[align="center"]
image::Создание и публикация объявления.png[width=90%]

[source,asciidoc]
----
1. Пользователь → Advertisement Service: Создание черновика
2. Клиент → S3: Прямая загрузка медиафайлов
3. S3 → Media Processor: Событие о новом файле
4. Media Processor → Admin Service: Запрос на модерацию
5. Admin Service → Advertisement Service: Подтверждение публикации
----

=== 2. Оформление заказа с оплатой и доставкой (Saga Pattern)

.Схема Saga Pattern для оформления заказа
[align="center"]
image::Оформление заказа с оплатой и доставкой.png[width=90%]

[source,asciidoc]
----
1. Покупатель → Order Service: Создание заказа
2. Order Service → Payment Service: Инициализация платежа
3. Payment Service → Внешний провайдер: Обработка платежа
4. Order Service → Delivery Service: Создание доставки
5. Все успешно → Order Service: Завершение Saga
6. Ошибка на любом шаге → Компенсационные транзакции
----

=== 3. Общение в чате между покупателем и продавцом

.Схема взаимодействия в чате
[align="center"]
image::Общение в чате между покупателем и продавцом.png[width=90%]

[source,asciidoc]
----
1. Пользователь → WebSocket Gateway: Установка соединения
2. WebSocket Gateway → Chat Service: Аутентификация
3. Chat Service → Redis: Сохранение статуса online
4. Отправка сообщения → Cassandra: Сохранение
5. Redis Pub/Sub → Все участники: Распространение
6. Если участник offline → Notification Service: Уведомление
----

=== 4. Смена статуса доставки и уведомления

.Схема обработки статусов доставки
[align="center"]
image::Смена статуса доставки и уведомления.png[width=90%]

[source,asciidoc]
----
1. Внешняя служба → Delivery Service: Webhook о статусе
2. Delivery Service → Kafka: Событие об изменении статуса
3. Kafka → Order Service: Обновление статуса заказа
4. Kafka → Notification Service: Создание уведомления
5. Notification Service → Пользователь: Отправка email/SMS/push
----

== Паттерны взаимодействия

[cols="1,2,3", options="header"]
|===
| Паттерн | Использование | Пример
| Request-Response | Синхронные операции | Поиск объявлений, получение профиля
| Event-Driven | Асинхронная обработка | Уведомления, обновления статусов
| Saga (Orchestrator) | Распределенные транзакции | Оформление заказа с оплатой
| CQRS | Отделение чтения от записи | Поиск объявлений vs создание
| API Gateway | Единая точка входа | Маршрутизация, аутентификация
| Circuit Breaker | Защита от сбоев зависимостей | Интеграции с платежными системами
| Publish-Subscribe | Многоадресная рассылка | Уведомления для всех сервисов
| Polling | Периодическая проверка | Трекинг посылок
| Webhooks | Callback от внешних систем | Статусы платежей, доставки
|===