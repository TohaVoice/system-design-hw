= Модель данных системы
:icons: font
:toc:

== Основные доменные сущности

=== User Service
[%collapsible]
====
*Структуры:*

* `User` - основные данные пользователя (email, хэш пароля, роль)
* `UserProfile` - расширенная информация (аватар, рейтинг, настройки)
* `Session` - активные сессии пользователей
* `AuditLog` - журнал действий пользователей

*Зависимости:*

* Нет внешних зависимостей, является источником данных о пользователях
* Используется всеми сервисами для аутентификации и авторизации

*Консистентность:*

* Сильная консистентность (ACID транзакции)
* Master-slave репликация для чтения профилей
* Eventual consistency для репликации в кэш Redis
====

=== Advertisement Service
[%collapsible]
====
*Структуры:*

* `Advertisement` - основная информация объявления
* `AdvertisementMedia` - прикрепленные медиафайлы
* `Category` - иерархия категорий товаров/услуг
* `Review` - отзывы и рейтинги

*Зависимости:*

* User Service (seller_id → User.id)
* S3 хранилище (медиафайлы)
* Search Service (индексация для поиска)

*Консистентность:*

* Eventual consistency между write и read моделями (CQRS)
* Сильная консистентность для модерации объявлений
* Асинхронная индексация в Elasticsearch (задержка до 5 секунд)
====

=== Order Service
[%collapsible]
====
*Структуры:*

* `Order` - информация о заказе
* `OrderItem` - товарные позиции в заказе
* `SagaInstance` - состояние распределенных транзакций
* `ReservedItem` - зарезервированные товары

*Зависимости:*

* User Service (buyer_id, seller_id)
* Advertisement Service (advertisement_id)
* Payment Service (внешняя ссылка)
* Delivery Service (внешняя ссылка)

*Консистентность:*

* Saga Pattern для распределенных транзакций
* Компенсационные транзакции при сбоях
* Сильная консистентность в рамках одного заказа
* Eventual consistency между сервисами
====

=== Payment Service
[%collapsible]
====
*Структуры:*

* `Payment` - информация о платеже
* `Refund` - данные о возвратах
* `Receipt` - электронные чеки (54-ФЗ)
* `TransactionLog` - журнал транзакций

*Зависимости:*

* Order Service (order_id)
* Внешние платежные системы (Stripe, Tinkoff)

*Консистентность:*

* Сильная консистентность (требования PCI DSS)
* Двухфазный commit с внешними платежными системами
* Гарантированная доставка вебхуков
====

=== Delivery Service
[%collapsible]
====
*Структуры:*

* `Delivery` - информация о доставке
* `TrackingEvent` - события трекинга
* `Warehouse` - склады и пункты выдачи
* `DeliveryTariff` - тарифы доставки

*Зависимости:*

* Order Service (order_id)
* Внешние службы доставки (СДЭК, Почта России)

*Консистентность:*

* Eventual consistency со внешними службами
* Периодическая синхронизация статусов (каждые 30 минут)
* Кэширование тарифов с TTL 24 часа
====

=== Chat Service
[%collapsible]
====
*Структуры:*

* `Conversation` - диалог между пользователями
* `Message` - сообщения в диалоге
* `Attachment` - прикрепленные файлы
* `OnlineStatus` - статус пользователей

*Зависимости:*

* User Service (participant_1, participant_2)
* S3 хранилище (прикрепленные файлы)

*Консистентность:*

* Eventual consistency для доставки сообщений
* Read-your-writes гарантии для отправителя
* Асинхронная репликация между датацентрами
====

=== Notification Service
[%collapsible]
====
*Структуры:*

* `Notification` - очередь уведомлений
* `Template` - шаблоны сообщений
* `DeliveryLog` - журнал отправки
* `UserPreference` - настройки уведомлений

*Зависимости:*

* Все сервисы (источники событий)
* Внешние сервисы отправки (SendGrid, Twilio, FCM)

*Консистентность:*

* At-least-once доставка
* Идемпотентная обработка событий
* Очереди с подтверждением доставки
====

== Ключевые зависимости между сущностями

[source,asciidoc]
----
User
├── Advertisement (1:N) - пользователь может иметь много объявлений
├── Order как buyer (1:N) - пользователь может иметь много заказов как покупатель
├── Order как seller (1:N) - пользователь может иметь много заказов как продавец
├── Review как author (1:N) - пользователь может оставить много отзывов
├── Review как target (1:N) - на пользователя могут оставить много отзывов
├── Conversation (2:N) - пользователь участвует в диалогах
└── Notification (1:N) - пользователь получает уведомления

Advertisement
├── Order (1:N) - на объявление может быть много заказов
├── AdvertisementMedia (1:N) - у объявления может быть много медиафайлов
├── Review (1:N) - у объявления могут быть отзывы
└── Conversation (1:N) - по объявлению может быть диалог

Order
├── Payment (1:1) - у заказа есть один платеж
├── Delivery (1:1) - у заказа есть одна доставка
├── OrderItem (1:N) - заказ содержит позиции
└── SagaInstance (1:1) - заказ управляется сагой
----

== Требования к консистентности по типам данных

=== Strong Consistency (сильная консистентность)
* Финансовые операции: платежи, возвраты, комиссии
* Резервирование товаров: предотвращение overselling
* Критичные бизнес-правила: статусы заказов, доступность услуг
* Аутентификация и авторизация: проверка прав доступа
* Модерация контента: предотвращение публикации запрещенного контента

=== Eventual Consistency (консистентность в конечном счете)
* Поиск и индексация: обновление поискового индекса
* Аналитика и отчетность: агрегация статистики
* Рейтинги и отзывы: расчет средних оценок
* Кэширование данных: обновление кэшированных данных
* Уведомления: доставка email/SMS/push

=== Causal Consistency (причинная консистентность)
* Чат и сообщения: порядок сообщений в диалоге
* История действий: последовательность событий пользователя
* Ленты и активности: порядок событий в ленте